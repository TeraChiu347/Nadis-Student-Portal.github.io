<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç´å¸æ€å­¸å“¡å°ˆå€</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <style>
    body { padding: 20px; background-color: #f5f5f5; min-height: 100vh; }
    .hidden { display: none; }
    .loader-box { text-align: center; margin-top: 50px; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3273dc; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loading" class="loader-box">
    <div class="loader"></div>
    <h3 class="title is-5">ç´å¸æ€å­¸å“¡å°ˆå€</h3>
    <p id="status">ç³»çµ±é€£ç·šä¸­...</p>
  </div>

  <div id="bind-section" class="container hidden">
    <div class="box">
      <h3 class="title is-4">ğŸ‘‹ æ­¡è¿åŠ å…¥</h3>
      <p class="mb-4">è«‹è¼¸å…¥æ‚¨çš„å­¸å“¡æš±ç¨±é€²è¡Œé©—è­‰</p>
      <input class="input is-large mb-4" type="text" id="inputKey" placeholder="ä¾‹å¦‚ï¼šTera888">
      <button class="button is-link is-fullwidth" onclick="doBind()">é©—è­‰èº«åˆ†</button>
    </div>
  </div>

  <div id="main-section" class="container hidden">
    <div class="box has-text-centered">
      <figure class="image is-64x64 is-inline-block mb-3">
        <img id="u-img" class="is-rounded" src="https://ui-avatars.com/api/?name=U">
      </figure>
      <h3 class="title is-4" id="u-name">å­¸å“¡</h3>
      <span class="tag is-primary is-medium" id="u-type">æœƒå“¡</span>
      <hr>
      <p class="is-size-7">æœƒç±åˆ°æœŸæ—¥</p>
      <p class="title is-5" id="u-expiry">-</p>
      <a id="u-link" href="#" class="button is-fullwidth is-link is-outlined mt-4">é€²å…¥ç¤¾åœ˜</a>
    </div>
  </div>

  <script>
    // â˜…â˜…â˜… è«‹å¡«å…¥æ‚¨å‰›å‰›è¤‡è£½çš„ GAS ç¶²å€ â˜…â˜…â˜…
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzZ7L8ZK46eEQsd3OA0G9vErxwFFuV3NmsC3rPg6NE5g28ws7vCNMI63AMwn6jGTcGQ/exec";
    
    // â˜…â˜…â˜… è«‹å¡«å…¥æ‚¨çš„ LIFF ID â˜…â˜…â˜…
    const MY_LIFF_ID = "2009073759-noDIM2Wm";

    window.onload = function() {
      liff.init({ liffId: MY_LIFF_ID })
        .then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            liff.getProfile().then(profile => {
              document.getElementById('status').innerText = "è®€å–è³‡æ–™åº«...";
              if(profile.pictureUrl) document.getElementById('u-img').src = profile.pictureUrl;
              callGasApi("getStudentData", { userId: profile.userId });
            });
          }
        })
        .catch(err => alert("LIFF éŒ¯èª¤: " + err));
    };

    function callGasApi(action, data) {
      // ä½¿ç”¨ fetch ç™¼é€è«‹æ±‚åˆ° GAS
      fetch(GAS_API_URL, {
        method: "POST",
        body: JSON.stringify({ action: action, ...data })
      })
      .then(res => res.json())
      .then(response => {
        document.getElementById('loading').classList.add('hidden');
        if (response.status === "new_user") {
          document.getElementById('bind-section').classList.remove('hidden');
        } else if (response.status === "success") {
          showUser(response.user);
        } else {
          alert("éŒ¯èª¤: " + response.message);
        }
      })
      .catch(err => {
        alert("é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        console.error(err);
      });
    }

    function showUser(user) {
      document.getElementById('bind-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('u-name').innerText = user.name;
      document.getElementById('u-type').innerText = user.identity === 'ANNUAL' ? 'å¹´ç¥¨æœƒå“¡' : 'æ³¢æ®µå­¸å“¡';
      document.getElementById('u-expiry').innerText = user.expiry;
      document.getElementById('u-link').href = user.groupUrl;
    }

    function doBind() {
      const key = document.getElementById('inputKey').value;
      if(!key) return alert("è«‹è¼¸å…¥æš±ç¨±");
      
      document.getElementById('status').innerText = "é©—è­‰ä¸­...";
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('bind-section').classList.add('hidden');

      liff.getProfile().then(profile => {
        callGasApi("bindUser", { userId: profile.userId, key: key });
      });
    }
  </script>
</body>
</html>