<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç´å¸æ€å­¸å“¡å°ˆå€</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <style>
    body { padding: 20px; background-color: #f5f5f5; min-height: 100vh; }
    .hidden { display: none; }
    .loader-box { text-align: center; margin-top: 50px; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3273dc; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .avatar-img { width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

  <div id="loading" class="loader-box">
    <div class="loader"></div>
    <h3 class="title is-5" style="color:#3273dc">ç´å¸æ€å­¸å“¡å°ˆå€</h3>
    <p id="status" class="has-text-grey">ç³»çµ±é€£ç·šä¸­...</p>
  </div>

  <div id="bind-section" class="container hidden">
    <div class="card">
      <div class="card-content has-text-centered">
        <h3 class="title is-4">ğŸ‘‹ æ­¡è¿åŠ å…¥</h3>
        <p class="mb-4">è«‹è¼¸å…¥æ‚¨çš„å­¸å“¡æš±ç¨±é€²è¡Œé©—è­‰</p>
        <input class="input is-large mb-4 has-text-centered" type="text" id="inputKey" placeholder="ä¾‹å¦‚ï¼šTera888">
        <button class="button is-link is-fullwidth is-medium" onclick="doBind()">é©—è­‰èº«åˆ†</button>
      </div>
    </div>
  </div>

  <div id="main-section" class="container hidden">
    <div class="card">
      <div class="card-content has-text-centered">
        <figure class="image is-inline-block mb-3">
          <img id="u-img" class="avatar-img" src="https://ui-avatars.com/api/?name=U" alt="User">
        </figure>
        <h3 class="title is-4" id="u-name">å­¸å“¡</h3>
        
        <div class="tags has-addons justify-center" style="justify-content: center; margin-bottom: 20px;">
           <span class="tag is-dark">èº«åˆ†</span>
           <span class="tag is-primary is-medium" id="u-type">æœƒå“¡</span>
        </div>

        <hr style="background-color: #eee; height: 1px; border: none;">
        
        <p class="is-size-7 has-text-grey">æœƒç±åˆ°æœŸæ—¥</p>
        <p class="title is-4" id="u-expiry" style="color: #363636;">-</p>
        
        <br>
        <a id="u-link" href="#" class="button is-fullwidth is-link is-outlined" target="_blank">é€²å…¥å°ˆå±¬ç¤¾åœ˜</a>
      </div>
    </div>
  </div>

  <script>
    // â–¼â–¼â–¼ è«‹å‹™å¿…æ›æˆå¦³è‡ªå·±çš„ GAS ç¶²å€ (å¾ GAS è¤‡è£½éä¾†) â–¼â–¼â–¼
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzZ7L8ZK46eEQsd3OA0G9vErxwFFuV3NmsC3rPg6NE5g28ws7vCNMI63AMwn6jGTcGQ/exec";
    
    // LIFF ID (ä¸ç”¨æ”¹)
    const MY_LIFF_ID = "2009073759-noDIM2Wm";

    window.onload = function() {
      liff.init({ liffId: MY_LIFF_ID })
        .then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            liff.getProfile().then(profile => {
              document.getElementById('status').innerText = "è®€å–è³‡æ–™åº«...";
              if(profile.pictureUrl) document.getElementById('u-img').src = profile.pictureUrl;
              callGasApi("getStudentData", { userId: profile.userId });
            });
          }
        })
        .catch(err => {
          document.getElementById('loading').innerHTML = "<p style='color:red'>LIFF éŒ¯èª¤: " + err + "</p>";
        });
    };

    function callGasApi(action, data) {
      fetch(GAS_API_URL, {
        method: "POST",
        body: JSON.stringify({ action: action, ...data })
      })
      .then(res => res.json())
      .then(response => {
        // æƒ…æ³ Aï¼šé€™æ˜¯ã€Œç¶å®šå‹•ä½œã€çš„å›å‚³ (çµæ§‹æ˜¯ success, msg)
        if (action === "bindUser") {
          if (response.success) {
            alert("ğŸ‰ ç¶å®šæˆåŠŸï¼");
            location.reload(); // é‡æ–°æ•´ç†é é¢ï¼Œè‡ªå‹•ç™»å…¥
          } else {
            alert("âŒ å¤±æ•—: " + response.msg);
            // å¤±æ•—å¾Œï¼Œæ¢å¾©ç•«é¢è®“ç”¨æˆ¶é‡è©¦ (è§£é–ä»‹é¢)
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('bind-section').classList.remove('hidden');
          }
          return;
        }

        // æƒ…æ³ Bï¼šé€™æ˜¯ã€ŒæŸ¥è©¢è³‡æ–™ã€çš„å›å‚³ (çµæ§‹æ˜¯ status, user)
        document.getElementById('loading').classList.add('hidden');
        if (response.status === "new_user") {
          // æ²’è³‡æ–™ -> é¡¯ç¤ºç¶å®šé 
          document.getElementById('bind-section').classList.remove('hidden');
        } else if (response.status === "success") {
          // æœ‰è³‡æ–™ -> é¡¯ç¤ºæœƒå“¡å¡
          showUser(response.user);
        } else {
          // å…¶ä»–éŒ¯èª¤
          let errorMsg = response.message || "æœªçŸ¥éŒ¯èª¤";
          alert("ç³»çµ±éŒ¯èª¤: " + errorMsg);
        }
      })
      .catch(err => {
        alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS ç¶²å€");
        console.error(err);
        // å¤±æ•—æ™‚ä¹Ÿæ¢å¾©é¡¯ç¤ºï¼Œé¿å…å¡æ­»
        if(action === "bindUser") {
           document.getElementById('loading').classList.add('hidden');
           document.getElementById('bind-section').classList.remove('hidden');
        }
      });
    }

    function showUser(user) {
      document.getElementById('bind-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('u-name').innerText = user.name;
      document.getElementById('u-type').innerText = user.identity === 'ANNUAL' ? 'å¹´ç¥¨æœƒå“¡' : 'æ³¢æ®µå­¸å“¡';
      
      // â˜… æ—¥æœŸç¾åŒ–åŠŸèƒ½ â˜…
      if (user.expiry) {
        let d = new Date(user.expiry);
        // æ ¼å¼åŒ–æˆ YYYY/MM/DD
        let dateStr = d.getFullYear() + '/' + (d.getMonth() + 1).toString().padStart(2, '0') + '/' + d.getDate().toString().padStart(2, '0');
        document.getElementById('u-expiry').innerText = dateStr;
      }
      
      document.getElementById('u-link').href = user.groupUrl;
    }

    function doBind() {
      const key = document.getElementById('inputKey').value;
      if(!key) return alert("è«‹è¼¸å…¥æš±ç¨±");
      
      // é¡¯ç¤ºè®€å–ä¸­ï¼Œéš±è—ç¶å®šå€
      document.getElementById('status').innerText = "é©—è­‰ä¸­...";
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('bind-section').classList.add('hidden');

      liff.getProfile().then(profile => {
        callGasApi("bindUser", { userId: profile.userId, key: key });
      });
    }
  </script>
</body>
</html>
