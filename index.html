<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç´å¸æ€å­¸å“¡å°ˆå€</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { background-color: #f5f5f5; min-height: 100vh; padding-bottom: 70px; } /* é ç•™åº•éƒ¨ç©ºé–“ */
    .hidden { display: none !important; }
    
    /* è¼‰å…¥å‹•ç•« */
    .loader-wrapper { 
      position: fixed; top:0; left:0; width:100%; height:100%; 
      background: #fff; z-index:99; display: flex; 
      justify-content: center; align-items: center; flex-direction: column; 
    }
    
    /* åº•éƒ¨å°èˆªåˆ— (App é¢¨æ ¼) */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: white; border-top: 1px solid #dbdbdb;
      display: flex; justify-content: space-around; padding: 10px 0;
      z-index: 50; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    .nav-item {
      text-align: center; color: #b5b5b5; cursor: pointer; flex: 1;
    }
    .nav-item.active { color: #3273dc; font-weight: bold; }
    .nav-item i { display: block; font-size: 1.2rem; margin-bottom: 2px; }
    .nav-item span { font-size: 0.75rem; }

    /* é é¢å®¹å™¨ */
    .page-container { padding: 20px; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* èª²ç¨‹å¡ç‰‡ */
    .course-card { margin-bottom: 15px; border-left: 4px solid #3273dc; }
  </style>
</head>
<body>

  <div id="loading" class="loader-wrapper">
    <div class="button is-loading is-white is-large" style="border:none;"></div>
    <p class="has-text-grey mt-3">ç´å¸æ€ç³»çµ±é€£ç·šä¸­...</p>
  </div>

  <div id="bind-section" class="page-container hidden">
    <div class="box">
      <h3 class="title is-4 has-text-centered">ğŸ‘‹ æ­¡è¿åŠ å…¥ç´å¸æ€</h3>
      <p class="mb-4 has-text-centered is-size-6">è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±<br>è‹¥ç‚ºæ–°æœ‹å‹ï¼Œç³»çµ±å°‡ç‚ºæ‚¨è‡ªå‹•è¨»å†Š</p>
      <div class="field">
        <div class="control has-icons-left">
          <input class="input is-large" type="text" id="inputKey" placeholder="ä¾‹å¦‚ï¼šTera888">
          <span class="icon is-small is-left"><i class="fas fa-user"></i></span>
        </div>
      </div>
      <button class="button is-link is-fullwidth is-medium" onclick="doBind()">ä¸‹ä¸€æ­¥</button>
    </div>
  </div>

  <div id="pending-section" class="page-container hidden">
    <div class="box has-text-centered">
      <span class="icon is-large has-text-warning mb-3"><i class="fas fa-clock fa-3x"></i></span>
      <h3 class="title is-4">å¸³è™Ÿå¯©æ ¸ä¸­</h3>
      <p class="mb-4">æ‚¨çš„è¨»å†Šç”³è«‹å·²é€å‡ºã€‚<br>è«‹é€šçŸ¥èª²å‹™äººå“¡ç‚ºæ‚¨é–‹é€šæ¬Šé™ã€‚</p>
      <button class="button is-light is-small" onclick="location.reload()">é‡æ–°æ•´ç†ç‹€æ…‹</button>
    </div>
  </div>

  <div id="main-app" class="hidden">
    
    <div id="tab-profile" class="page-container">
      <div class="box has-text-centered">
        <figure class="image is-96x96 is-inline-block mb-3">
          <img id="u-img" class="is-rounded" src="https://ui-avatars.com/api/?name=User&background=random" style="box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
        </figure>
        <h3 class="title is-4 mb-1" id="u-name">è¼‰å…¥ä¸­...</h3>
        <span class="tag is-primary is-light" id="u-type">æœƒå“¡</span>
        <hr>
        <div class="columns is-mobile">
          <div class="column">
            <p class="heading">æœƒç±åˆ°æœŸ</p>
            <p class="title is-6" id="u-expiry">-</p>
          </div>
          <div class="column">
            <p class="heading">ç‹€æ…‹</p>
            <p class="title is-6 has-text-success">æ­£å¸¸</p>
          </div>
        </div>
        <a id="u-link" href="#" target="_blank" class="button is-link is-outlined is-fullwidth mt-2">
          <span class="icon"><i class="fab fa-facebook"></i></span>
          <span>é€²å…¥å°ˆå±¬ç¤¾åœ˜</span>
        </a>
      </div>
    </div>

    <div id="tab-courses" class="page-container hidden">
      <h3 class="title is-5 pl-2" style="border-left: 4px solid #3273dc;">ğŸ“… è¿‘æœŸé–‹èª²è³‡è¨Š</h3>
      <div id="course-list-container">
        <p class="has-text-grey has-text-centered mt-5">è¼‰å…¥ä¸­...</p>
      </div>
    </div>

    <div id="tab-payment" class="page-container hidden">
      <div class="box">
        <h3 class="title is-5 mb-3"><i class="fas fa-credit-card mr-2"></i>ç¹³è²»è³‡è¨Š</h3>
        <div class="content is-small">
          <p><strong>éŠ€è¡Œä»£ç¢¼ï¼š</strong> 808 (ç‰å±±éŠ€è¡Œ)</p>
          <p><strong>å¸³è™Ÿï¼š</strong> 1234-5678-9012</p>
          <p><strong>æˆ¶åï¼š</strong> ç´å¸æ€å•†å­¸é™¢</p>
          <hr>
          <p class="has-text-grey">åŒ¯æ¬¾å¾Œè«‹æˆªåœ–å‚³é€çµ¦èª²å‹™ç¢ºèªã€‚</p>
        </div>
        <a href="https://line.me/R/ti/p/@your_line_id" class="button is-success is-fullwidth">
          <span class="icon"><i class="fab fa-line"></i></span>
          <span>é€šçŸ¥å·²åŒ¯æ¬¾</span>
        </a>
      </div>
    </div>

  </div>

  <div id="bottom-nav" class="bottom-nav hidden">
    <div class="nav-item active" onclick="switchTab('profile')">
      <i class="fas fa-id-card"></i>
      <span>æˆ‘çš„è³‡æ–™</span>
    </div>
    <div class="nav-item" onclick="switchTab('courses')">
      <i class="fas fa-chalkboard-teacher"></i>
      <span>è¿‘æœŸèª²ç¨‹</span>
    </div>
    <div class="nav-item" onclick="switchTab('payment')">
      <i class="fas fa-hand-holding-usd"></i>
      <span>æˆ‘è¦ç¹³è²»</span>
    </div>
  </div>

  <script>
    // â˜…â˜…â˜… è«‹å¡«å…¥æ‚¨çš„ GAS ç¶²å€ â˜…â˜…â˜…
    const GAS_API_URL = "https://script.google.com/macros/s/xxxxxxxxx/exec";
    
    // â˜…â˜…â˜… LIFF ID â˜…â˜…â˜…
    const MY_LIFF_ID = "2009073759-noDIM2Wm";

    let currentUserProfile = null;

    window.onload = function() {
      liff.init({ liffId: MY_LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) { liff.login(); } 
        else {
          liff.getProfile().then(profile => {
            currentUserProfile = profile;
            callGasApi("getStudentData", { userId: profile.userId });
            // é †ä¾¿é è¼‰èª²ç¨‹è³‡æ–™
            loadPublicCourses();
          });
        }
      });
    };

    function callGasApi(action, data) {
      fetch(GAS_API_URL, {
        method: "POST",
        body: JSON.stringify({ action: action, ...data })
      })
      .then(res => res.json())
      .then(response => {
        document.getElementById('loading').classList.add('hidden');
        
        if (action === "getStudentData") {
          if (response.status === "new_user") {
            document.getElementById('bind-section').classList.remove('hidden');
          } else if (response.status === "pending") {
            document.getElementById('pending-section').classList.remove('hidden');
          } else if (response.status === "success") {
            showMainApp(response.user);
          }
        } 
        else if (action === "bindUser") {
           if(response.success) {
             alert(response.msg);
             location.reload();
           } else {
             alert(response.msg);
             document.getElementById('loading').classList.add('hidden');
           }
        }
      });
    }

    function loadPublicCourses() {
      fetch(GAS_API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "getPublicCourses" })
      })
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('course-list-container');
        container.innerHTML = "";
        if(data.list && data.list.length > 0) {
          data.list.forEach(c => {
            container.innerHTML += `
              <div class="box course-card">
                <p class="title is-6">${c.name}</p>
                <p class="subtitle is-7 has-text-grey">${c.date} | ${c.type}</p>
              </div>`;
          });
        } else {
          container.innerHTML = "<p>ç›®å‰æ²’æœ‰å…¬é–‹èª²ç¨‹</p>";
        }
      });
    }

    function showMainApp(user) {
      document.getElementById('main-app').classList.remove('hidden');
      document.getElementById('bottom-nav').classList.remove('hidden');
      
      // å¡«å…¥è³‡æ–™
      document.getElementById('u-name').innerText = user.name;
      document.getElementById('u-type').innerText = user.identity === 'ANNUAL' ? 'å¹´ç¥¨æœƒå“¡' : 'å­¸å“¡';
      document.getElementById('u-expiry').innerText = user.expiry;
      document.getElementById('u-link').href = user.groupUrl;
      if(currentUserProfile.pictureUrl) {
         document.getElementById('u-img').src = currentUserProfile.pictureUrl;
      }
    }

    function doBind() {
      const key = document.getElementById('inputKey').value;
      if(!key) return alert("è«‹è¼¸å…¥æš±ç¨±");
      document.getElementById('loading').classList.remove('hidden');
      callGasApi("bindUser", { userId: currentUserProfile.userId, key: key });
    }

    // åˆ‡æ›åˆ†é é‚è¼¯
    function switchTab(tabName) {
      // éš±è—æ‰€æœ‰åˆ†é 
      ['profile', 'courses', 'payment'].forEach(t => {
        document.getElementById('tab-' + t).classList.add('hidden');
      });
      // é¡¯ç¤ºç›®æ¨™åˆ†é 
      document.getElementById('tab-' + tabName).classList.remove('hidden');
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      const items = document.querySelectorAll('.nav-item');
      items.forEach(item => item.classList.remove('active'));
      
      // æ ¹æ“šé»æ“Šçš„ä½ç½®äº®ç‡ˆ (é€™è£¡ç°¡å–®è™•ç†ï¼Œå»ºè­°ä¾é †åº)
      if(tabName === 'profile') items[0].classList.add('active');
      if(tabName === 'courses') items[1].classList.add('active');
      if(tabName === 'payment') items[2].classList.add('active');
    }
  </script>
</body>
</html>
